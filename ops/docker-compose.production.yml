# Production Docker Compose Configuration for bestviable.com Infrastructure
# Implements SyncBricks pattern with:
# - nginx-proxy for auto-discovery reverse proxy
# - acme-companion for automatic SSL certificate management
# - Two-network design (proxy + backend isolation)
# - Token-based Cloudflare Tunnel for secure connectivity
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your values
#   docker-compose -f docker-compose.production.yml up -d
#
# Environment Variables Required (.env file):
#   CF_TUNNEL_TOKEN=<token from Cloudflare Zero Trust>
#   POSTGRES_PASSWORD=<secure random password>
#   N8N_ADMIN_EMAIL=<your email>
#   N8N_ADMIN_PASSWORD=<secure random password>
#   N8N_ENCRYPTION_KEY=<secure random key>
#   DOMAIN=bestviable.com
#   LETSENCRYPT_EMAIL=<email for Let's Encrypt>

services:
  # ============================================================================
  # REVERSE PROXY & SSL MANAGEMENT
  # ============================================================================

  nginx-proxy:
    image: nginxproxy/nginx-proxy:latest
    container_name: nginx-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
    networks:
      - proxy
    environment:
      - TRUST_DOWNSTREAM_PROXY=false
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"

  acme-companion:
    image: nginxproxy/acme-companion:latest
    container_name: acme-companion
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      - ./acme:/etc/acme.sh
    networks:
      - proxy
    environment:
      - NGINX_PROXY_CONTAINER=nginx-proxy
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL:-admin@bestviable.com}
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/acme.sh/bestviable.com/bestviable.com.cer"]
      interval: 300s
      timeout: 10s
      retries: 1
      start_period: 60s

  # ============================================================================
  # CLOUDFLARE TUNNEL
  # ============================================================================

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: always
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    networks:
      - proxy
    depends_on:
      - nginx-proxy
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # DATABASE (BACKEND NETWORK - ISOLATED)
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - syncbricks
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # VECTOR DATABASE (BACKEND NETWORK - ISOLATED)
  # ============================================================================

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    environment:
      QDRANT_API_KEY: ${QDRANT_API_KEY:-change-me}
      QDRANT__STORAGE__SNAPSHOTS_PATH: /qdrant/snapshots
    volumes:
      - ./data/qdrant:/qdrant/storage
      - ./data/qdrant/snapshots:/qdrant/snapshots
    networks:
      - syncbricks
    healthcheck:
      test: ["CMD-SHELL", "test -f /qdrant/storage/raft_state.json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # N8N AUTOMATION ENGINE (HYBRID - BOTH NETWORKS)
  # ============================================================================

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: always
    environment:
      # Database Configuration
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SSL: "false"

      # n8n Admin Configuration
      N8N_ADMIN_EMAIL: ${N8N_ADMIN_EMAIL}
      N8N_ADMIN_PASSWORD: ${N8N_ADMIN_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # Security
      N8N_SECURE_COOKIE: "true"
      N8N_SECURE_COOKIE_SECURE_ONLY: "true"
      N8N_SECURE_COOKIE_HTTP_ONLY: "true"
      N8N_SECURE_COOKIE_SAME_SITE: "Lax"

      # SSL/TLS via nginx-proxy (not needed in container)
      N8N_PROTOCOL: http
      N8N_HOST: n8n.${DOMAIN}
      N8N_PORT: 5678
      N8N_PATH: /
      NODE_ENV: production

      # Optional: Qdrant Vector Store Integration
      N8N_CUSTOM_EXTENSIONS_FOLDER: /home/node/.n8n/custom

      # Logging
      LOG_LEVEL: info

    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./custom:/home/node/.n8n/custom
    networks:
      - proxy
      - syncbricks
    ports:
      - "127.0.0.1:5678:5678"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      # nginx-proxy auto-discovery
      - "virtual.host=n8n.${DOMAIN}"
      - "virtual.port=5678"

      # Let's Encrypt certificate auto-generation
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=n8n.${DOMAIN}"
      - "letsencrypt.host=n8n.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # N8N IMPORT (HELPER SERVICE - BACKEND NETWORK)
  # ============================================================================

  n8n-import:
    image: n8nio/n8n:latest
    container_name: n8n-import
    restart: "no"
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SSL: "false"
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./import:/import
    networks:
      - syncbricks
    command: n8n import:credentials --input=/import/credentials.json
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - donotstart

  # ============================================================================
  # CODA MCP GATEWAY (HYBRID - BOTH NETWORKS)
  # ============================================================================

  coda-mcp-gateway:
    build:
      context: ./coda-mcp-gateway
      dockerfile: Dockerfile
    image: coda-mcp-gateway:latest
    container_name: coda-mcp-gateway
    restart: always
    environment:
      # Gateway Configuration
      PORT: 8080
      LOG_LEVEL: info

      # Coda API Configuration
      CODA_API_TOKEN: ${CODA_API_TOKEN}

      # SSL/TLS via nginx-proxy (not needed in container)
      NODE_ENV: production

    volumes:
      - ./data/coda-mcp:/app/data
    networks:
      - proxy
      - syncbricks
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      - n8n
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # nginx-proxy auto-discovery
      - "virtual.host=coda.${DOMAIN}"
      - "virtual.port=8080"

      # Let's Encrypt certificate auto-generation
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=coda.${DOMAIN}"
      - "letsencrypt.host=coda.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"
    security_opt:
      - no-new-privileges:true

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  # Public-facing services (nginx-proxy, acme-companion, cloudflared, n8n, coda-mcp-gateway)
  proxy:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # Backend services only (postgres, qdrant, n8n, coda-mcp-gateway)
  # Isolated from internet-facing services
  syncbricks:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  n8n_data:
    driver: local
  coda_mcp_data:
    driver: local
