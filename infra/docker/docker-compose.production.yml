# Production Docker Compose Configuration for bestviable.com Infrastructure
# Implements SyncBricks pattern with:
# - nginx-proxy for auto-discovery reverse proxy
# - acme-companion for automatic SSL certificate management
# - Two-network design (proxy + backend isolation)
# - Token-based Cloudflare Tunnel for secure connectivity
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your values
#   docker-compose -f docker-compose.production.yml up -d
#
# Environment Variables Required (.env file):
#   CF_TUNNEL_TOKEN=<token from Cloudflare Zero Trust>
#   POSTGRES_PASSWORD=<secure random password>
#   N8N_ADMIN_EMAIL=<your email>
#   N8N_ADMIN_PASSWORD=<secure random password>
#   N8N_ENCRYPTION_KEY=<secure random key>
#   DOMAIN=bestviable.com
#   LETSENCRYPT_EMAIL=<email for Let's Encrypt>

services:
  # ============================================================================
  # REVERSE PROXY & SSL MANAGEMENT
  # ============================================================================

  nginx-proxy:
    image: nginxproxy/nginx-proxy:latest
    container_name: nginx-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
    networks:
      - proxy
    environment:
      - TRUST_DOWNSTREAM_PROXY=true
    healthcheck:
      disable: true
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"

  acme-companion:
    image: nginxproxy/acme-companion:latest
    container_name: acme-companion
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      - ./acme:/etc/acme.sh
    networks:
      - proxy
    environment:
      - NGINX_PROXY_CONTAINER=nginx-proxy
      # ACME account contact (Let's Encrypt still issues certificates; they simply stopped expiration reminder emails)
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL:-admin@bestviable.com}
    healthcheck:
      test: ["CMD-SHELL", "test -d /etc/acme.sh || exit 1"]
      interval: 300s
      timeout: 10s
      retries: 1
      start_period: 60s

  # ============================================================================
  # CLOUDFLARE TUNNEL
  # ============================================================================

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: always
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    networks:
      - proxy
    depends_on:
      - nginx-proxy
    healthcheck:
      disable: true

  # ============================================================================
  # DATABASE (BACKEND NETWORK - ISOLATED)
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - syncbricks
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # VECTOR DATABASE (BACKEND NETWORK - ISOLATED)
  # ============================================================================

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    environment:
      QDRANT_API_KEY: ${QDRANT_API_KEY:-change-me}
      QDRANT__STORAGE__SNAPSHOTS_PATH: /qdrant/snapshots
    volumes:
      - ./data/qdrant:/qdrant/storage
      - ./data/qdrant/snapshots:/qdrant/snapshots
    networks:
      - syncbricks
    healthcheck:
      test: ["CMD-SHELL", "test -f /qdrant/storage/raft_state.json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # N8N AUTOMATION ENGINE (HYBRID - BOTH NETWORKS)
  # ============================================================================

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: always
    environment:
      # Database Configuration
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SSL: "false"

      # n8n Admin Configuration
      N8N_ADMIN_EMAIL: ${N8N_ADMIN_EMAIL}
      N8N_ADMIN_PASSWORD: ${N8N_ADMIN_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # Security
      N8N_SECURE_COOKIE: "true"
      N8N_SECURE_COOKIE_SECURE_ONLY: "true"
      N8N_SECURE_COOKIE_HTTP_ONLY: "true"
      N8N_SECURE_COOKIE_SAME_SITE: "Lax"

      # Reverse Proxy Discovery
      VIRTUAL_HOST: n8n.${DOMAIN}
      VIRTUAL_PORT: 5678
      # ACME certificate request (Letâ€™s Encrypt naming retained for acme-companion compatibility)
      LETSENCRYPT_HOST: n8n.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}

      # SSL/TLS via nginx-proxy (HTTPS is terminated before n8n)
      N8N_PROTOCOL: https
      N8N_HOST: n8n.${DOMAIN}
      N8N_PORT: 5678        # keep container listening on its default port
      N8N_PATH: /
      N8N_EDITOR_BASE_URL: https://n8n.${DOMAIN}/
      N8N_API_BASE_URL: https://n8n.${DOMAIN}/
      WEBHOOK_URL: https://n8n.${DOMAIN}/
      NODE_ENV: production
      N8N_EXTERNAL_FRONTEND_BASE_URL: https://n8n.${DOMAIN}/
      HTTPS_METHOD: noredirect

      # Optional: Qdrant Vector Store Integration
      N8N_CUSTOM_EXTENSIONS_FOLDER: /home/node/.n8n/custom

      # Logging
      LOG_LEVEL: info

    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./custom:/home/node/.n8n/custom
    networks:
      - proxy
      - syncbricks
    ports:
      - "127.0.0.1:5678:5678"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "if pgrep -f 'node.*n8n' > /dev/null; then exit 0; else exit 1; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      # Let's Encrypt certificate auto-generation
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=n8n.${DOMAIN}"
      - "letsencrypt.host=n8n.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # N8N IMPORT (HELPER SERVICE - BACKEND NETWORK)
  # ============================================================================

  n8n-import:
    image: n8nio/n8n:latest
    container_name: n8n-import
    restart: "no"
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SSL: "false"
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./import:/import
    networks:
      - syncbricks
    command: n8n import:credentials --input=/import/credentials.json
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - donotstart

  # ============================================================================
  # CODA MCP GATEWAY (HYBRID - BOTH NETWORKS)
  # ============================================================================

  coda-mcp-gateway:
    build:
      context: ../..
      dockerfile: integrations/mcp/servers/coda/gateway/Dockerfile
    image: coda-mcp-gateway:latest
    container_name: coda-mcp-gateway
    restart: always
    environment:
      # Gateway Configuration
      SERVICE_NAME: coda-mcp
      SERVICE_VERSION: 1.4.2
      PORT: 8080
      NODE_ENV: production

      # Coda API Configuration
      CODA_API_TOKEN: ${CODA_API_TOKEN}

      # Reverse Proxy Discovery (nginx-proxy auto-discovery)
      VIRTUAL_HOST: coda.${DOMAIN}
      VIRTUAL_PORT: 8080

      # ACME certificate management (acme-companion)
      LETSENCRYPT_HOST: coda.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}

    networks:
      - proxy
      - syncbricks

    ports:
      - "127.0.0.1:8080:8080"

    depends_on:
      - nginx-proxy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      # Let's Encrypt certificate auto-generation
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=coda.${DOMAIN}"
      - "letsencrypt.host=coda.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"

    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # GITHUB MCP GATEWAY (HTTP GATEWAY)
  # ============================================================================

  github-mcp-gateway:
    build:
      context: ../..
      dockerfile: integrations/mcp/servers/github/gateway/Dockerfile
    image: github-mcp-gateway:latest
    container_name: github-mcp-gateway
    restart: always
    environment:
      SERVICE_NAME: github-mcp
      SERVICE_VERSION: 1.0.0
      PORT: 8081
      NODE_ENV: production

      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}

      VIRTUAL_HOST: github.${DOMAIN}
      VIRTUAL_PORT: 8081
      LETSENCRYPT_HOST: github.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}
      HTTPS_METHOD: noredirect

    networks:
      - proxy
      - syncbricks

    ports:
      - "127.0.0.1:8081:8081"

    depends_on:
      - nginx-proxy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=github.${DOMAIN}"
      - "letsencrypt.host=github.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"

    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # MEMORY MCP GATEWAY (HTTP GATEWAY)
  # ============================================================================

  memory-mcp-gateway:
    build:
      context: ../..
      dockerfile: integrations/mcp/servers/memory/gateway/Dockerfile
    image: memory-mcp-gateway:latest
    container_name: memory-mcp-gateway
    restart: always
    environment:
      SERVICE_NAME: memory-mcp
      SERVICE_VERSION: 1.0.0
      PORT: 8082
      NODE_ENV: production

      VIRTUAL_HOST: memory.${DOMAIN}
      VIRTUAL_PORT: 8082
      LETSENCRYPT_HOST: memory.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}
      HTTPS_METHOD: noredirect

    volumes:
      - ./data/memory-mcp:/data

    networks:
      - proxy
      - syncbricks

    ports:
      - "127.0.0.1:8082:8082"

    depends_on:
      - nginx-proxy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=memory.${DOMAIN}"
      - "letsencrypt.host=memory.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"

    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # FIRECRAWL MCP GATEWAY (HTTP GATEWAY)
  # ============================================================================

  firecrawl-mcp-gateway:
    build:
      context: ../..
      dockerfile: integrations/mcp/servers/firecrawl/gateway/Dockerfile
    image: firecrawl-mcp-gateway:latest
    container_name: firecrawl-mcp-gateway
    restart: always
    environment:
      SERVICE_NAME: firecrawl-mcp
      SERVICE_VERSION: 1.0.0
      PORT: 8084
      NODE_ENV: production

      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY}

      VIRTUAL_HOST: firecrawl.${DOMAIN}
      VIRTUAL_PORT: 8084
      LETSENCRYPT_HOST: firecrawl.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}
      HTTPS_METHOD: noredirect

    networks:
      - proxy
      - syncbricks

    ports:
      - "127.0.0.1:8084:8084"

    depends_on:
      - nginx-proxy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=firecrawl.${DOMAIN}"
      - "letsencrypt.host=firecrawl.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"

    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # DIGITALOCEAN MCP GATEWAY (REMOTE TRANSPORT)
  # ============================================================================

  digitalocean-mcp-gateway:
    build:
      context: ../..
      dockerfile: infra/docker/services/digitalocean-mcp.Dockerfile
    image: digitalocean-mcp-gateway:latest
    container_name: digitalocean-mcp-gateway
    restart: always
    environment:
      MCP_PROXY_PORT: 8082
      DIGITALOCEAN_API_TOKEN: ${DIGITALOCEAN_API_TOKEN}
      DIGITALOCEAN_SERVICES: ${DIGITALOCEAN_SERVICES:-}
      DIGITALOCEAN_API_ENDPOINT: ${DIGITALOCEAN_API_ENDPOINT:-https://api.digitalocean.com}
      DIGITALOCEAN_LOG_LEVEL: ${DIGITALOCEAN_LOG_LEVEL:-info}
      VIRTUAL_HOST: digitalocean.${DOMAIN}
      VIRTUAL_PORT: 8082
      LETSENCRYPT_HOST: digitalocean.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}
      HTTPS_METHOD: noredirect
    networks:
      - proxy
    ports:
      - "127.0.0.1:8082:8082"
    depends_on:
      - nginx-proxy
    healthcheck:
      test: ["CMD-SHELL", "if pgrep -f 'mcp-digitalocean' > /dev/null; then exit 0; else exit 1; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=digitalocean.${DOMAIN}"
      - "letsencrypt.host=digitalocean.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # CLOUDFLARE MCP GATEWAY (REMOTE TRANSPORT WRAPPER)
  # ============================================================================

  cloudflare-mcp-gateway:
    build:
      context: ../..
      dockerfile: infra/docker/services/cloudflare-mcp.Dockerfile
    image: cloudflare-mcp-gateway:latest
    container_name: cloudflare-mcp-gateway
    restart: always
    environment:
      MCP_PROXY_PORT: 8083
      CLOUDFLARE_REMOTE_URL: ${CLOUDFLARE_REMOTE_URL}
      CLOUDFLARE_TRANSPORT_STRATEGY: ${CLOUDFLARE_TRANSPORT_STRATEGY:-http-first}
      CLOUDFLARE_CALLBACK_PORT: ${CLOUDFLARE_CALLBACK_PORT:-}
      CLOUDFLARE_HEADERS: ${CLOUDFLARE_HEADERS:-}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:-}
      CLOUDFLARE_IGNORE_TOOLS: ${CLOUDFLARE_IGNORE_TOOLS:-}
      VIRTUAL_HOST: cloudflare.${DOMAIN}
      VIRTUAL_PORT: 8083
      LETSENCRYPT_HOST: cloudflare.${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-admin@bestviable.com}
      HTTPS_METHOD: noredirect
    networks:
      - proxy
    ports:
      - "127.0.0.1:8083:8083"
    depends_on:
      - nginx-proxy
    healthcheck:
      test: ["CMD-SHELL", "if pgrep -f 'mcp-remote' > /dev/null; then exit 0; else exit 1; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.main=cloudflare.${DOMAIN}"
      - "letsencrypt.host=cloudflare.${DOMAIN}"
      - "letsencrypt.email=${LETSENCRYPT_EMAIL:-admin@bestviable.com}"
    security_opt:
      - no-new-privileges:true
    profiles:
      - optional

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  # Public-facing services (nginx-proxy, acme-companion, cloudflared, n8n, coda-mcp-gateway)
  proxy:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # Backend services only (postgres, qdrant, n8n, coda-mcp-gateway)
  # Isolated from internet-facing services
  syncbricks:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  n8n_data:
    driver: local
  coda_mcp_data:
    driver: local
