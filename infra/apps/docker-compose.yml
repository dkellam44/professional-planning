version: '3.8'

networks:
  n8n_proxy:
    external: true
  n8n_syncbricks:
    external: true

services:
  # ============================================================================
  # DOZZLE - Log Viewer (lightweight)
  # ============================================================================
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    ports:
      - "127.0.0.1:9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - n8n_proxy
    environment:
      - DOZZLE_LEVEL=info
      - DOZZLE_BASE=/
      - VIRTUAL_HOST=logs.bestviable.com
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=logs.bestviable.com
      - LETSENCRYPT_EMAIL=admin@bestviable.com
    deploy:
      resources:
        limits:
          memory: 50m

  # ============================================================================
  # OPEN WEBUI - Chat Interface
  # ============================================================================
  openweb:
    image: ghcr.io/open-webui/open-webui:0.6.34
    container_name: openweb
    restart: unless-stopped
    networks:
      - n8n_proxy
      - n8n_syncbricks
    environment:
      - OPENAI_API_BASE_URL=https://openrouter.ai/api/v1
      - OPENAI_API_KEY=${OPENROUTER_API_KEY:-sk-or-CHANGEME}
      - WEBUI_AUTH=true
      - WEBUI_NAME=David's Memory Control Plane
      - ENABLE_RAG_WEB_SEARCH=true
      - ENABLE_OAUTH_SIGNUP=false
      - VIRTUAL_HOST=openweb.bestviable.com
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=openweb.bestviable.com
      - LETSENCRYPT_EMAIL=admin@bestviable.com
    volumes:
      - openweb_data:/app/backend/data
    deploy:
      resources:
        limits:
          memory: 1000m
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --quiet --tries=1 --spider http://localhost:8080 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 5

  # ============================================================================
  # OPENMEMORY - Memory Backend (DEFERRED - Build custom image in Phase 3)
  # ============================================================================
  # Placeholder for OpenMemory deployment
  # To deploy: Build Dockerfile in integrations/mcp/servers/openmemory-proxy/

  # ============================================================================
  # UPTIME KUMA - Service Monitoring
  # ============================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    networks:
      - n8n_proxy
    volumes:
      - kuma_data:/app/data
    environment:
      - VIRTUAL_HOST=kuma.bestviable.com
      - VIRTUAL_PORT=3001
      - LETSENCRYPT_HOST=kuma.bestviable.com
      - LETSENCRYPT_EMAIL=admin@bestviable.com
    deploy:
      resources:
        limits:
          memory: 100m

  # ============================================================================
  # LITELLM - LLM Proxy with BYOK Management
  # ============================================================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm
    restart: unless-stopped
    networks:
      - n8n_proxy
      - n8n_syncbricks
    volumes:
      - ../litellm/litellm-config.yaml:/app/config.yaml:ro
      - ../litellm/data:/app/data
    environment:
      - LITELLM_CONFIG_PATH=/app/config.yaml
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-litellm-CHANGEME}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - VIRTUAL_HOST=litellm.bestviable.com
      - VIRTUAL_PORT=4000
      - LETSENCRYPT_HOST=litellm.bestviable.com
      - LETSENCRYPT_EMAIL=admin@bestviable.com
    deploy:
      resources:
        limits:
          memory: 500m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  openweb_data:
  kuma_data:
