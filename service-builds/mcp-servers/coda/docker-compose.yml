version: '3.8'

services:
  coda-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coda-mcp
    restart: unless-stopped
    # Port binding handled by Traefik reverse proxy
    # ports:
    #   - "8080:8080"
    environment:
      # Stytch OAuth 2.1 Configuration
      - STYTCH_PROJECT_ID=${STYTCH_PROJECT_ID}
      - STYTCH_SECRET=${STYTCH_SECRET}
      - STYTCH_PUBLIC_TOKEN=${STYTCH_PUBLIC_TOKEN}

      # OAuth 2.0 Configuration
      - JWT_SECRET=${JWT_SECRET}

      # Coda API Configuration
      - CODA_API_TOKEN=${CODA_API_TOKEN}
      - CODA_API_BASE_URL=https://coda.io/apis/v1

      # Server Configuration
      - PORT=8080
      - HOST=0.0.0.0
      - BASE_URL=https://coda.bestviable.com
      - LOG_LEVEL=info

      # Legacy: Cloudflare Access (deprecated, kept for backward compatibility)
      # - AUTH_MODE=cloudflare
      # - CLOUDFLARE_ACCESS_TEAM_DOMAIN=bestviable.cloudflareaccess.com
      # - CLOUDFLARE_ACCESS_AUD=bestviable

      # Legacy: Bearer token (deprecated, kept for backward compatibility)
      # - BEARER_TOKEN=${BEARER_TOKEN}
      
    networks:
      - docker_proxy       # Traefik v3.0 auto-discovery
      - docker_syncbricks  # Internal network for service communication

    labels:
      # Traefik v3.0 auto-discovery labels (HTTP only via Cloudflare Tunnel)
      # Architecture: Cloudflare terminates HTTPS/TLS → HTTP tunnel → Traefik:80 → Service:8080
      - "traefik.enable=true"
      - "traefik.http.routers.coda-mcp.rule=Host(`coda.bestviable.com`)"
      - "traefik.http.routers.coda-mcp.entrypoints=web"
      - "traefik.http.services.coda-mcp.loadbalancer.server.port=8080"

      # Service metadata
      - "com.bestviable.service=coda-mcp"
      - "com.bestviable.auth=stytch-oauth21"
      
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:8080/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  docker_proxy:
    external: true
  docker_syncbricks:
    external: true