# Coda MCP Server - Bug Fixes Summary
**Date:** 2025-11-17
**Status:** ‚úÖ All Critical Bugs Fixed

## Overview

Fixed 8 critical bugs preventing OAuth 2.1 authorization flow from working with MCP clients (Claude.ai, ChatGPT). All fixes based on official [Stytch MCP Server Guide](https://stytch.com/docs/guides/connected-apps/mcp-server-overview).

---

## üî¥ Critical Bugs Fixed

### Bug #1: Missing STYTCH_DOMAIN Environment Variable
**Impact:** Server could not communicate with Stytch authorization server

**Root Cause:**
- `STYTCH_DOMAIN` referenced in code but never defined in configuration
- Fallback to wrong domain (`https://coda.bestviable.com` instead of Stytch domain)

**Files Fixed:**
- ‚úÖ `.env.example` - Added `STYTCH_DOMAIN` with documentation
- ‚úÖ `src/config.ts` - Added to type definition and required env vars
- ‚úÖ `src/config.ts` - Added to validation logging

**Example Value:**
```bash
STYTCH_DOMAIN=https://your-project-slug.customers.stytch.com
```

---

### Bug #2: Wrong Fallback Values in oauth-metadata.ts
**Impact:** MCP clients directed to wrong authorization server

**Root Cause:**
```typescript
// WRONG - Falls back to MCP server instead of Stytch
const stytchDomain = process.env.STYTCH_DOMAIN || 'https://coda.bestviable.com';
```

**Fix:**
- Removed fallback values entirely
- Now uses `config.stytch.domain` (fails fast if missing)
- Added import of centralized config

**Files Fixed:**
- ‚úÖ `src/routes/oauth-metadata.ts` - Lines 27, 35, 67

---

### Bug #3: Stytch Client Initialization Issues
**Impact:** Could not properly initialize Stytch SDK

**Root Cause:**
- Used raw `process.env` instead of validated config
- Redundant validation logic in middleware

**Fix:**
```typescript
// BEFORE
const projectId = process.env.STYTCH_PROJECT_ID;
const secret = process.env.STYTCH_SECRET;
const domain = process.env.STYTCH_DOMAIN;
// ... validation logic ...

// AFTER
stytchClient = new StytchClient({
  project_id: config.stytch.projectId,
  secret: config.stytch.secret,
  custom_base_url: config.stytch.domain,
});
```

**Files Fixed:**
- ‚úÖ `src/middleware/stytch-auth.ts` - Lines 10-28

---

### Bug #4: Incorrect WWW-Authenticate Headers
**Impact:** MCP clients couldn't discover authorization flow

**Root Cause:**
- Used `process.env.BASE_URL` with wrong fallback
- Didn't match official guide format

**Fix (per Stytch Guide):**
```typescript
// AFTER
const wwwAuthValue = `Bearer error="Unauthorized", ` +
  `error_description="Unauthorized", ` +
  `resource_metadata="${req.get('host')}/.well-known/oauth-protected-resource"`;
```

**Files Fixed:**
- ‚úÖ `src/middleware/stytch-auth.ts` - Lines 60-62, 102-104

---

## üü° Medium Priority Bugs Fixed

### Bug #5: Response Structure Simplified
**Impact:** Potential field mismatch issues

**Root Cause:**
- Manually parsing `tokenData` fields instead of using whole response
- Didn't match official Stytch guide pattern

**Fix:**
```typescript
// BEFORE
const userId = tokenData.sub || 'unknown';
const userEmail = tokenData.email || 'unknown';
const sessionId = tokenData.session_id || accessToken.substring(0, 20);
req.user = { user_id: userId, email: userEmail, ... };

// AFTER (matches official guide)
req.user = tokenData;
```

**Files Fixed:**
- ‚úÖ `src/middleware/stytch-auth.ts` - Lines 82-83
- ‚úÖ `src/middleware/stytch-auth.ts` - Interface simplified to `user?: any`

---

### Bug #6: Incorrect Error Messages
**Impact:** Confusing error responses

**Fix:**
- Standardized error format to match official guide
- Removed redundant `message` field (already have `error`)

**Files Fixed:**
- ‚úÖ `src/middleware/stytch-auth.ts` - Lines 65-68, 107-110

---

## üü¢ Minor Bugs Fixed

### Bug #7: Misleading Logging
**Impact:** Developers confused about which endpoints are hosted where

**Root Cause:**
- Logged RFC 8414 endpoint as if hosted by MCP server
- Actually hosted by Stytch

**Fix:**
```typescript
// BEFORE
console.log(`- RFC 8414: http://${config.host}:${config.port}/.well-known/oauth-authorization-server`);

// AFTER
console.log(`Auth Server (hosted by Stytch):`);
console.log(`  - ${config.stytch.domain}/.well-known/oauth-authorization-server`);
```

**Files Fixed:**
- ‚úÖ `src/http-server.ts` - Lines 172-182
- ‚úÖ `src/http-server.ts` - Health endpoint (lines 36-41)

---

### Bug #8: Configuration Cleanup
**Impact:** Code consistency

**Fix:**
- Use `config.codaApiToken` instead of `process.env.CODA_API_TOKEN`
- Use `config.logLevel` instead of `process.env.LOG_LEVEL`
- Centralized configuration access

**Files Fixed:**
- ‚úÖ `src/middleware/stytch-auth.ts` - Lines 87, 90

---

## üìã Files Modified Summary

| File | Lines Changed | Type |
|------|---------------|------|
| `.env.example` | +4 | Config |
| `src/config.ts` | +3 | Config |
| `src/routes/oauth-metadata.ts` | ~10 | Critical |
| `src/middleware/stytch-auth.ts` | ~40 | Critical |
| `src/http-server.ts` | ~15 | Logging |

**Total:** 5 files modified, ~70 lines changed

---

## ‚úÖ Verification Checklist

Before deploying, verify:

- [ ] `STYTCH_DOMAIN` is set in your actual `.env` file
- [ ] Value format: `https://<your-project-slug>.customers.stytch.com`
- [ ] Get this from Stytch Dashboard ‚Üí Connected Apps settings
- [ ] Rebuild Docker image: `docker-compose build --no-cache`
- [ ] Restart service: `docker-compose up -d`
- [ ] Check logs: `docker logs coda-mcp -f`
- [ ] Test health endpoint: `curl https://coda.bestviable.com/health`
- [ ] Test protected resource metadata: `curl https://coda.bestviable.com/.well-known/oauth-protected-resource`

---

## üîß Expected Behavior After Fixes

### 1. Server Startup
```
‚úÖ Configuration validated successfully
   Auth provider: Stytch OAuth 2.1
   Stytch Project ID: project-test-xxxxx
   Stytch Domain: https://your-slug.customers.stytch.com
   Base URL: https://coda.bestviable.com
   ...

üöÄ Coda MCP server started (Phase 2: Stytch OAuth 2.1)
   URL: http://0.0.0.0:8080
   Auth: Stytch OAuth 2.1 with PKCE
   Stytch Domain: https://your-slug.customers.stytch.com
   Endpoints:
     - MCP: http://0.0.0.0:8080/mcp
     - Health: http://0.0.0.0:8080/health
     - Protected Resource Metadata (RFC 9728): http://0.0.0.0:8080/.well-known/oauth-protected-resource
   Auth Server (hosted by Stytch):
     - https://your-slug.customers.stytch.com/.well-known/oauth-authorization-server
```

### 2. Health Check Response
```json
{
  "status": "ok",
  "service": "coda-mcp",
  "version": "2.0.0",
  "auth": {
    "provider": "stytch",
    "oauth_compliant": true,
    "stytch_domain": "https://your-slug.customers.stytch.com",
    "authorization_server": "https://your-slug.customers.stytch.com/.well-known/oauth-authorization-server",
    "protected_resource": "https://coda.bestviable.com/.well-known/oauth-protected-resource"
  },
  "timestamp": "2025-11-17T..."
}
```

### 3. Protected Resource Metadata
```json
{
  "resource": "https://coda.bestviable.com",
  "authorization_servers": [
    "https://your-slug.customers.stytch.com"
  ],
  "scopes_supported": [
    "openid",
    "email",
    "profile",
    "mcp.read",
    "mcp.write",
    "mcp.tools"
  ],
  "bearer_methods_supported": ["header"],
  "resource_signing_alg_values_supported": ["RS256"]
}
```

### 4. Unauthorized Request (No Token)
```bash
$ curl -D - https://coda.bestviable.com/mcp

HTTP/2 401
www-authenticate: Bearer error="Unauthorized", error_description="Unauthorized", resource_metadata="coda.bestviable.com/.well-known/oauth-protected-resource"

{
  "error": "Unauthorized",
  "timestamp": "2025-11-17T..."
}
```

---

## üîê OAuth 2.1 Flow (Now Working)

1. **MCP Client ‚Üí MCP Server** (No auth)
   - Response: `401` with `WWW-Authenticate` header

2. **MCP Client ‚Üí Protected Resource Metadata**
   - `GET /.well-known/oauth-protected-resource`
   - Response: Authorization server = `https://your-slug.customers.stytch.com`

3. **MCP Client ‚Üí Authorization Server Metadata** (Stytch)
   - `GET https://your-slug.customers.stytch.com/.well-known/oauth-authorization-server`
   - Response: Token endpoint, registration endpoint, etc.

4. **MCP Client ‚Üí Stytch** (DCR if needed)
   - Dynamic Client Registration
   - Receives `client_id`

5. **User ‚Üí Browser ‚Üí Stytch** (Consent)
   - User logs in and grants consent
   - Redirected back with authorization code

6. **MCP Client ‚Üí Stytch** (Token Exchange)
   - Exchanges code for access token
   - Uses PKCE for security

7. **MCP Client ‚Üí MCP Server** (With Token)
   - `POST /mcp` with `Authorization: Bearer <token>`
   - Token validated via `client.idp.introspectTokenLocal()`
   - Request processed ‚úÖ

---

## üö® Next Steps

1. **Get STYTCH_DOMAIN:**
   - Log into https://stytch.com/dashboard
   - Go to Connected Apps
   - Copy your project domain

2. **Update Production .env:**
   ```bash
   ssh droplet
   cd /home/david/services/mcp-servers/coda
   nano .env
   # Add: STYTCH_DOMAIN=https://your-slug.customers.stytch.com
   ```

3. **Rebuild & Deploy:**
   ```bash
   docker-compose down
   docker-compose build --no-cache
   docker-compose up -d
   docker logs coda-mcp -f
   ```

4. **Test Authorization Flow:**
   - Try connecting from Claude.ai or ChatGPT
   - Should now complete OAuth flow successfully
   - Check MCP client can call tools

---

## üìö Reference Documentation

- [Official Stytch MCP Guide](https://stytch.com/docs/guides/connected-apps/mcp-server-overview)
- [MCP Specification](https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization)
- [RFC 9728 - Protected Resource Metadata](https://datatracker.ietf.org/doc/html/rfc9728)
- [RFC 8414 - Authorization Server Metadata](https://datatracker.ietf.org/doc/html/rfc8414)

---

**All bugs fixed!** üéâ Authorization flow should now work correctly with Stytch OAuth 2.1.
