================================================================================
                         DEPLOYMENT ACTION PLAN
                    Docker Health Checks Fix - Oct 27, 2025
================================================================================

SITUATION:
  ‚úÖ All 7 containers running on droplet
  ‚ö†Ô∏è  5/7 showing "unhealthy" (false negatives due to broken health checks)
  ‚úÖ Analysis complete + fixes implemented locally

STATUS:
  Ready for deployment to droplet

================================================================================
                            IMMEDIATE ACTIONS
================================================================================

STEP 1: SYNC UPDATED CONFIG (1 minute)

  From your local machine:

    cd ~/workspace/portfolio/ops
    scp docker-compose.production.yml root@tools:~/portfolio/ops/

STEP 2: DEPLOY ON DROPLET (5 minutes)

  SSH to droplet:
    ssh root@tools
    cd ~/portfolio/ops

  Deploy (choose one):

    OPTION A - Automated (recommended):
      bash DEPLOY_FIXES.sh
      [Watch output until all services show HEALTHY, then Ctrl+C]

    OPTION B - Manual:
      docker compose -f docker-compose.production.yml down
      docker compose -f docker-compose.production.yml up -d
      watch -n 3 'docker compose -f docker-compose.production.yml ps'
      [Wait 2-3 minutes until all show HEALTHY, then Ctrl+C]

STEP 3: VERIFY (2 minutes)

  From droplet:

    # Check all containers healthy
    docker compose -f docker-compose.production.yml ps

    # Test endpoints
    curl -I http://localhost:5678      # n8n
    curl -I http://localhost:8080      # coda
    curl -I http://localhost/          # nginx

    # Check tunnel (if needed)
    docker compose -f docker-compose.production.yml logs cloudflared | grep -i connected

================================================================================
                            WHAT WAS FIXED
================================================================================

docker-compose.production.yml health check updates:

  ‚úÖ nginx-proxy       - Now checks for ports 80/443 listening (not /health)
  ‚úÖ acme-companion    - Now checks for /etc/acme.sh directory (not cert file)
  ‚úÖ cloudflared       - Now checks for process running (not tunnel info)
  ‚úÖ n8n               - Increased startup time 60s ‚Üí 120s, added fallback endpoint
  ‚úÖ coda-mcp-gateway  - Increased startup time 30s ‚Üí 120s, added fallback endpoint

Result: All 5 services will report healthy within 2-3 minutes of startup

================================================================================
                          SUPPORTING DOCUMENTS
================================================================================

For Different Needs, See:

  üìÑ README_DEPLOYMENT_2025-10-27.md
     ‚Üí TL;DR overview and deployment steps

  üìã INSTRUCTIONS_FOR_DEPLOYMENT.md
     ‚Üí Detailed step-by-step guide with all options

  üìã DEPLOYMENT_SUMMARY_2025-10-27.md
     ‚Üí Full technical analysis of each fix

  üìù FIX_HEALTH_CHECKS.md
     ‚Üí Line-by-line explanation of changes

  üîß TROUBLESHOOT_HEALTH_CHECKS.sh
     ‚Üí Run on droplet if something goes wrong

  ‚ö° QUICK_REFERENCE.txt
     ‚Üí One-page cheat sheet

================================================================================
                          ROLLBACK PLAN
================================================================================

If deployment fails:

  docker compose -f docker-compose.production.yml down
  cp docker-compose.production.yml.backup.* docker-compose.production.yml
  docker compose -f docker-compose.production.yml up -d

(Note: docker compose auto-creates .backup file before each deployment)

================================================================================
                         SUCCESS CRITERIA
================================================================================

After deployment, all should be TRUE:

  ‚úÖ All 7 containers show "healthy" (docker compose ps)
  ‚úÖ n8n responds at http://localhost:5678
  ‚úÖ Coda responds at http://localhost:8080
  ‚úÖ Nginx responds at http://localhost
  ‚úÖ Cloudflare tunnel shows CONNECTED
  ‚úÖ Can reach https://n8n.bestviable.com
  ‚úÖ Can reach https://coda.bestviable.com

================================================================================
                        TIMELINE ESTIMATE
================================================================================

Sync config:           ~1 min
Restart containers:    ~30 sec
Health checks pass:    ~2-3 min
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total time to ready:   ~4-5 minutes
Downtime during restart: ~2-3 minutes

================================================================================
                          KEY POINTS
================================================================================

‚úì NO functional changes - only health check logic
‚úì NO environment variable changes needed
‚úì NO network/port changes needed
‚úì NO service dependency changes needed
‚úì Services will resume automatically after restart
‚úì Persistent data (n8n, postgres, qdrant) preserved
‚úì Easy rollback if needed

================================================================================
                        DEPLOYMENT STARTED
================================================================================

Next action: Sync docker-compose.production.yml to droplet

Command:
  cd ~/workspace/portfolio/ops
  scp docker-compose.production.yml root@tools:~/portfolio/ops/

Then SSH to droplet and run:
  bash DEPLOY_FIXES.sh

Questions? See supporting documents listed above.

================================================================================
